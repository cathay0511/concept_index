<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>border of life</title>
  <!-- <link rel="stylesheet" href="/static/css/vis-network.min.css"> -->
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_6m5pnmufekdtpgb9.css">
  <link rel="stylesheet" href="/static/css/basic.css">
  <link rel="stylesheet" href="/static/css/ctx.css">
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://unpkg.com/vue/dist/vue.js"></script>

</head>
<body>

<div class="cai-header">
  <span style="float: left; margin-left: 20px; font-size: 16px; width: 163px; text-align: left;">simple &! common</span>
  <span style="display: inline-block; width: 192px;">en taro zeratul</span>
  <!--<span class="fr" style="margin-right: 20px; font-size: 16px;">八云哲学体系</span>-->
  {% if user %}
    <a style="float: right; font-size: 16px; color: #999; margin-right: 20px; text-decoration: none;" href="/api/logout">|&nbsp;登出</a>
    <span style="float: right; font-size: 16px; color: #999;">{{user.name}}&nbsp;</span>
  {% else %}
    <a style="float: right; font-size: 16px; color: #999; margin-right: 20px; text-decoration: none;" href="/login">登陆</a>
  {% endif %}
</div>
<div class="cai-body-container">
  <div id="cai_full_network" class="cai-full-network"></div>
  <div class="cai-cept-detail">
      <input class="hidden-cid" type="hidden" name="cid">
      <input class="hidden-ispub" type="hidden" name="ispub">
      <div class="cai-row cai-cept-detail-name">
        <span class="cai-cept-name"></span>
      </div>
      <div class="cai-row cai-cept-detail-desc">
        <textarea class="cai-cept-desc" disabled="true"></textarea>
      </div>
  </div>
</div>

<script src="/static/js/vis.min.js"></script>

<script type="text/javascript">
  var userId = {{userId}};

  var originCid = 0;
  if (window.location.hash != "") {
    var hash = window.location.hash.split("#");
    originCid = parseInt(hash[1]);
  }

  var originConceptDetail = {};
  var container = document.getElementById('cai_full_network');
  var ctxInfoList = {};
  var network = new vis.Network(container, {}, {});

  var nodes = new vis.DataSet([
    {id: 1, label: 'Node 1'},
    {id: 2, label: 'Node 2'},
    {id: 3, label: 'Node 3'},
    {id: 4, label: 'Node 4'},
    {id: 5, label: 'Node 5'}
  ]);

  // create an array with edges
  var edges = new vis.DataSet([
    {from: 1, to: 3},
    {from: 1, to: 2},
    {from: 2, to: 4},
    {from: 2, to: 5},
    {from: 3, to: 3}
  ]);

  // create a network
  var data = {
    nodes: nodes,
    edges: edges
  };
  var options = {
    autoResize: true,
    height: '100%',
    width: '100%'
  };
  var network = new vis.Network(container, data, options);

  function refreshConcept(cid) {
    originCid = cid;
    if (!cid) {
      refreshDetail({});
      refreshContext({}, {});
      return 0;
    }

    network = new vis.Network(container, {}, {});
    $.ajax({
        type: 'get',
        dataType: 'json',
        contentType: 'application/json',
        url: '/api/getCeptById/' + cid
    }).done(function (ret) {
      refreshDetail(ret.detail);
      refreshContext(ret.ctx, ret.ctxInfoList, originCid);
    }).fail(function (jqXHR, textStatus) {
        // Not 200:
        alert('Error: ' + jqXHR.status);
    });
  }

  function refreshContext(conceptContext, newCtxInfoList) {
    network.off("click");

    ctxInfoList = newCtxInfoList;

    if (conceptContext && conceptContext.length > 0) {
      var nd = {};
      var edgesData = [];
      for (var i = 0; i < conceptContext.length; i++) {
        var item = conceptContext[i];
        nd[item.cid] = 1;
        nd[item.context_concept_id] = 1;

        var bgColor = '#0066FF';
        if (ctxInfoList[item.cid].user_id != userId) {
          bgColor = 'green';
        } else if (ctxInfoList[item.cid].is_public) {
          bgColor = ' #00FF00';
        }

        if (ctxInfoList[item.context_concept_id].dirty) {
          bgColor = '#666666';
        }

        edgesData.push({
          from: item.cid,
          to: item.context_concept_id,
          arrows:'to',
          color: bgColor
        });
      }
      var nodesData = [];
      for (var key in nd) {
        var item = ctxInfoList[key];
        var bgColor = '#0066FF';
        if (item.user_id != userId) {
          bgColor = 'green';
          if (item.dirty) {
            bgColor = ' #666666';
          }
        } else if (item.is_public) {
          bgColor = ' #00FF00';
        }

        nodesData.push({
          id: key,
          label: item.name,
          color: {background: bgColor, highlight: {background: bgColor}, hover: {background: bgColor}},
          font: {color: '#ffffff'}
        });
      }
      network = new vis.Network(container, {
          nodes: new vis.DataSet(nodesData),
          edges: new vis.DataSet(edgesData)
        }, {
          interaction: {
            hover: true
          },
          layout: {
            randomSeed: 2
          }
        }
      );

      var options = {
        scale: 0,
        offset: {x:0, y:0},
        animation: {
          duration: 1000,
          easingFunction: "easeInOutQuad"
        }
      };
      network.focus(originCid, options);
    } else {
      network = new vis.Network(container, {}, {});
    }

    network.on("click", function (params) {
      if (params.nodes.length > 0) {
        var cid = parseInt(params.nodes[0]);
        if (ctxInfoList[cid].dirty) {
          alert('dirty');
          return;
        }

        var options = {
          scale: 1.0,
          offset: {x:0, y:0},
          animation: {
            duration: 1000,
            easingFunction: "easeInOutQuad"
          }
        };
        network.focus(cid, options);

        $.ajax({
            type: 'get',
            dataType: 'json',
            contentType: 'application/json',
            url: '/api/getCeptDetailById/' + cid
        }).done(function (ret) {
          if (ret && ret.id > 0) {
            refreshDetail(ret);
          }
        }).fail(function (jqXHR, textStatus) {
            // Not 200:
            alert('Error: ' + jqXHR.status);
        });
      }
    });
  }

  function refreshDetail(detail) {
    if (detail.id > 0) {
      $('.cai-cept-detail .hidden-cid').val(detail.id);
      $('.cai-cept-detail .hidden-ispub').val(detail.is_public);
      $('.cai-cept-detail .cai-cept-name').html(detail.name);
      $('.cai-cept-detail .cai-cept-username').html(detail.user_name);
      $('.cai-cept-detail .cai-cept-desc').html(detail.description);
    }
  }

  refreshConcept(originCid);
</script>

</body>
</html>
